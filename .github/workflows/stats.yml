name: Update GitHub Stats

on:
  schedule:
    - cron: "0 0 * * *"   # обновлять раз в день
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate GitHub Stats
        # Генерируем статистику через внешний API
        # Используем тему dracula с красивыми цветами
        # Если сервис недоступен, оставляем существующий файл
        run: |
          # Функция для проверки валидности SVG
          check_svg() {
            if [ -s "$1" ] && ! grep -qiE "error|unavailable|503|404|deployment_paused" "$1" && grep -q "<svg" "$1"; then
              return 0
            fi
            return 1
          }
          
          # Пробуем разные сервисы по очереди
          SERVICES=(
            "https://github-readme-stats.vercel.app/api?username=tanat0&theme=dracula&show_icons=true&hide_border=true&include_all_commits=true&count_private=true"
            "https://stats.ryo-chan.dev/api?username=tanat0&theme=dracula&show_icons=true&hide_border=true&include_all_commits=true&count_private=true"
          )
          
          for service in "${SERVICES[@]}"; do
            echo "Trying service: $service"
            curl -s -L --max-time 10 "$service" > github-stats.svg
            if check_svg github-stats.svg; then
              echo "Successfully generated stats from service"
              break
            fi
          done
          
          # Если все сервисы недоступны, оставляем существующий файл
          if ! check_svg github-stats.svg; then
            echo "All services unavailable, keeping existing file"
            git checkout github-stats.svg 2>/dev/null || true
          fi

      - name: Commit stats
        uses: EndBug/add-and-commit@v9
        with:
          message: "update github stats"
          add: "github-stats.svg"

